<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة الطالب | المشاعل</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://www.googleapis.com https://firebaseinstallations.googleapis.com; script-src 'self' https://www.gstatic.com https://www.googleapis.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://*; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://firebaseinstallations.googleapis.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self'">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--panel:#111827ee;--card:#0b1220;--muted:#94a3b8;--text:#e5e7eb;--pri:#06b6d4;--pri-2:#22d3ee;--ok:#22c55e;--ring:0 0 0 3px color-mix(in oklab, var(--pri) 35%, transparent)}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:linear-gradient(160deg,#0b1020,#0a1428 55%,#0c1b2f);color:var(--text);font-family:"Tajawal",system-ui,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(10px);background:#0b1220cc;border-bottom:1px solid #1f2937}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}.brand .logo{width:36px;height:36px;border-radius:10px;background:radial-gradient(circle at 30% 30%, #22d3ee, #06b6d4 40%, #0ea5e9 70%, transparent 71%), linear-gradient(135deg,#0ea5e9,#06b6d4)}.brand h1{font-size:20px;margin:0}
    .grid{display:grid;gap:16px}@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:linear-gradient(180deg,#0e1628,#0b1220);border:1px solid #1f2a3a;border-radius:16px;padding:16px}
    .card h2{margin:0 0 12px;font-size:18px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 16px}
    .btn{background:linear-gradient(135deg,#0891b2,#06b6d4);color:#001018;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .table{width:100%;border-collapse:collapse}.table th,.table td{padding:10px;border-bottom:1px solid #1f2a3a;text-align:center}
    .pill{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}.pill.ok{background:#052e1a;color:#52ffa2;border:1px solid #0a5}.pill.warn{background:#2e1f05;color:#ffd38a;border:1px solid #a60}
    .muted{color:var(--muted)}.cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}@media(min-width:900px){.cards{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .metric{background:#0b1825;border:1px solid #1f2a3a;padding:14px;border-radius:14px}.metric .v{font-size:26px;font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center">
      <div class="brand"><div class="logo" aria-hidden="true"></div><h1>لوحة الطالب - المشاعل</h1></div>
      <div role="group" aria-label="عمليات">
        <button id="btnRefresh" class="btn">تحديث البيانات</button>
        <button id="btnSignOut" class="btn">تسجيل الخروج</button>
      </div>
    </div>
  </header>
  <main class="container">
    <section class="cards" aria-label="ملخص">
      <div class="metric"><div class="muted">عدد المواد</div><div class="v" id="metricSubjects">-</div></div>
      <div class="metric"><div class="muted">الاختبارات القادمة</div><div class="v" id="metricUpcoming">-</div></div>
      <div class="metric"><div class="muted">المعدل التراكمي</div><div class="v" id="metricGPA">-</div></div>
      <div class="metric"><div class="muted">نسبة الحضور</div><div class="v" id="metricAttendance">-</div></div>
    </section>
    <div class="toolbar">
      <div>
        <select id="termFilter"><option value="current">الفصل الحالي</option><option value="prev">الفصل السابق</option></select>
        <input id="subjectFilter" placeholder="ابحث عن مادة..."/>
      </div>
      <small class="muted">البيانات من Firestore</small>
    </div>
    <section class="grid">
      <div class="card">
        <h2>جدول الحصص</h2>
        <table class="table" id="tableSchedule"><thead><tr><th>اليوم</th><th>الوقت</th><th>المادة</th><th>المعلم</th><th>المكان</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h2>الاختبارات القادمة</h2>
        <table class="table" id="tableExams"><thead><tr><th>التاريخ</th><th>المادة</th><th>نوع</th><th>المدى</th><th>الحالة</th></tr></thead><tbody></tbody></table>
      </div>
    </section>
    <section class="grid">
      <div class="card">
        <h2>النتائج</h2>
        <table class="table" id="tableResults"><thead><tr><th>المادة</th><th>الواجبات</th><th>الاختبارات</th><th>النهائي</th><th>التقدير</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h2>التحليل البياني</h2>
        <canvas id="chartGrades" height="160"></canvas>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = { apiKey: "YOUR_FIREBASE_API_KEY", authDomain: "YOUR_PROJECT.firebaseapp.com", projectId: "YOUR_PROJECT_ID", storageBucket: "YOUR_PROJECT.appspot.com", messagingSenderId: "SENDER_ID", appId: "APP_ID" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const scheduleBody = document.querySelector('#tableSchedule tbody');
    const examsBody = document.querySelector('#tableExams tbody');
    const resultsBody = document.querySelector('#tableResults tbody');

    function row(cols){ const tr=document.createElement('tr'); cols.forEach(c=>{ const td=document.createElement('td'); if(c instanceof Node) td.appendChild(c); else td.textContent=c ?? '—'; tr.appendChild(td);}); return tr; }
    function pill(text, cls){ const s=document.createElement('span'); s.className=`pill ${cls||''}`; s.textContent=text; return s; }
    function letter(total){ if(total>=95) return 'A+'; if(total>=90) return 'A'; if(total>=85) return 'B+'; if(total>=80) return 'B'; if(total>=75) return 'C+'; if(total>=70) return 'C'; if(total>=60) return 'D'; return 'F'; }

    async function loadMetrics(uid){ const snap=await getDoc(doc(db,'students',uid)); const d=snap.exists()?snap.data():{}; $('metricSubjects').textContent=d.subjectCount ?? '-'; $('metricGPA').textContent=d.gpa ?? '-'; $('metricAttendance').textContent=d.attendancePct?`${d.attendancePct}%`:'-'; const examsQ=query(collection(db,'students',uid,'exams'), where('date','>=', new Date().toISOString().slice(0,10)), orderBy('date'), limit(10)); const eSnap=await getDocs(examsQ); $('metricUpcoming').textContent=eSnap.size; }
    async function loadSchedule(uid){ scheduleBody.innerHTML=''; const qy=query(collection(db,'students',uid,'schedule'), orderBy('day'), orderBy('time')); const snap=await getDocs(qy); snap.forEach(docu=>{ const d=docu.data(); scheduleBody.appendChild(row([d.day,d.time,d.subject,d.teacher,d.room]));}); if(!snap.size) scheduleBody.appendChild(row(['—','—','لا توجد حصص','—','—'])); }
    async function loadExams(uid){ examsBody.innerHTML=''; const today=new Date().toISOString().slice(0,10); const qy=query(collection(db,'students',uid,'exams'), orderBy('date')); const snap=await getDocs(qy); snap.forEach(docu=>{ const d=docu.data(); const status=d.date<today?pill('انتهى','warn'):pill('قادِم','ok'); const tdS=document.createElement('td'); tdS.appendChild(status); const tr=document.createElement('tr'); ['date','subject','type','range'].forEach(k=>{ const td=document.createElement('td'); td.textContent=d[k] ?? '—'; tr.appendChild(td);}); tr.appendChild(tdS); examsBody.appendChild(tr);}); if(!snap.size) examsBody.appendChild(row(['—','—','—','—','—'])); }
    async function loadResults(uid){ resultsBody.innerHTML=''; const qy=query(collection(db,'students',uid,'results')); const snap=await getDocs(qy); const labels=[], totals=[]; snap.forEach(docu=>{ const d=docu.data(); const total=(+d.assignments||0)+(+d.exams||0)+(+d.final||0); labels.push(d.subject); totals.push(total); resultsBody.appendChild(row([d.subject,d.assignments,d.exams,d.final,letter(total)]));}); if(!snap.size) resultsBody.appendChild(row(['—','—','—','—','—'])); draw(labels, totals); }

    function draw(labels,data){ const c=$('chartGrades'); const ctx=c.getContext('2d'); const w=c.width=c.clientWidth||600; const h=c.height; ctx.clearRect(0,0,w,h); const pad=24, top=20, bottom=h-28, left=pad, right=w-pad; const max=Math.max(100, ...data, 0); ctx.strokeStyle='#1f2a3a'; ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,bottom); ctx.lineTo(right,bottom); ctx.stroke(); ctx.fillStyle='#94a3b8'; ctx.font='12px Tajawal'; for(let i=0;i<=5;i++){ const y=bottom-(bottom-top)*i/5; ctx.strokeStyle='#122033'; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke(); ctx.fillText(String(Math.round(max*i/5)),4,y-2);} if(!labels.length) return; const n=labels.length, gap=8, barW=Math.max(6,(right-left-gap*(n+1))/n); labels.forEach((lab,i)=>{ const x=left+gap+(barW+gap)*i; const val=data[i]||0; const y=bottom-(val/max)*(bottom-top); ctx.fillStyle='#22d3ee'; ctx.fillRect(x,y,barW,bottom-y); ctx.save(); ctx.translate(x+barW/2,bottom+12); ctx.rotate(-Math.PI/6); ctx.textAlign='center'; ctx.fillStyle='#94a3b8'; ctx.fillText(lab,0,0); ctx.restore();}); }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ console.warn('not signed in'); return; }
      await Promise.all([loadMetrics(user.uid), loadSchedule(user.uid), loadExams(user.uid), loadResults(user.uid)]);
    });

    document.getElementById('btnRefresh').addEventListener('click', ()=>{ const u=auth.currentUser; if(u){ loadMetrics(u.uid); loadSchedule(u.uid); loadExams(u.uid); loadResults(u.uid); }});
    document.getElementById('btnSignOut').addEventListener('click', ()=> signOut(auth));
  </script>
</body>
</html>
